<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Solum M2 Demo</title>
Instructions: Drag and drop the icons in the canvas area.  Then right click two separate
icons to draw a line between them.<br>Disclaimer: This is in an early phase still with many 
known bugs.<br><br>
4/22/2014 Updates:<br>
* Right clicking both icons which are already connected disconnects them.<br>
* Icons only glow (gradient green) when connected properly now.<br>
* Enforcing connection orders now.  Load Balancer -> Language Pack -> Service.<br>
        <link href="../bootstrap-3.1.1-dist/css/bootstrap.min.css" rel="stylesheet">
		<script src="./createjs-2013.12.12.min.js" oldsrc="http://code.createjs.com/createjs-2013.12.12.min.js"></script>

        <script>
// TODO: Replace the CDN link above with a local CreateJS instance
        
        // General global variables
        var canvas, stage, queue, fps, target_width, target_height, container_list;
        var max_target_dist, glow_start_color, glow_end_color, line_color;
        var mouse_status, last_mouse_obj, conn_list;

		// ***** Configuration *****
		// Screen positioning and distance configuration
		fps = 30;
		max_target_dist = 80; // Pixels from mid of target box to register a snap
		target_width = 80; // All targets are this width in pixels
		target_height = 80; // All targets are this height in pixels
		glow_start_color = "#009900"; // dark green (gradient)
		glow_end_color = "#EEFFEE"; // light green (gradient)
		mouse_status = 0; // 0 = none, 1 = mousedown, 2 = mouseup, 3 = pressmove, 4 = right click, 5 = doubleclick
		last_mouse_obj = null;
		container_list = new Array();
		conn_list = new Array(); // lines between icons


		// HTML div id names (like <div id="name">)
		canvas_name = "canvas";

		// Icon scaling/positioning
		line_color = "#000000" // Connecting line between icons
		line_width = 6;
		// Trove
		trove_icon = "images/database.png";
		trove_name = "trove";
		trove_x_scale = 0.2; // Scale trove icon to this % in the x direction
		trove_y_scale = 0.2; // Scale trove icon to this % in the y direction
		trove_x = 750; // Trove icon x starting location
		trove_y = 50; // Trove icon y starting location
		trove_conn_type = 2;
		// Python
		python_icon = "images/python.png";
		python_name = "python";
		python_x_scale = 0.25;
		python_y_scale = 0.25;
		python_x = 500;
		python_y = 50;
		python_conn_type = 1;
		// Java
		java_icon = "images/java.png";
		java_name = "java";
		java_x_scale = 0.25;
		java_y_scale = 0.25;
		java_x = 400;
		java_y = 45;
		java_conn_type = 1;
		// Ruby
		ruby_icon = "images/ruby.png";
		ruby_name = "ruby";
		ruby_x_scale = 0.75;
		ruby_y_scale = 0.75;
		ruby_x = 300;
		ruby_y = 50;
		ruby_conn_type = 1;
		// Load Balancer
		lb_icon = "images/loadbalancer.png";
		lb_name = "lb";
		lb_x_scale = 0.8;
		lb_y_scale = 0.8;
		lb_x = 30;
		lb_y = 50;
		lb_conn_type = 0;


		function preinit() {
        	canvas = document.getElementById(canvas_name);
			// Prevent right clicking window from bringing up a browswer menu
        	canvas.oncontextmenu = function(e) {
				e.preventDefault();
        	}
            stage = new createjs.Stage(canvas);
            stage.mouseMoveOutside = true;

			// Load all files and resources
			queue = new createjs.LoadQueue(false);
			queue.addEventListener("complete", init);
			queue.loadManifest([
				{id:python_name, src:python_icon},
				{id:trove_name, src:trove_icon},
				{id:java_name, src:java_icon},
				{id:ruby_name, src:ruby_icon},
				{id:lb_name, src:lb_icon},
				]);
		}


        function init() {
        	// Create the icon/draggers
			create_icon(python_name, python_x, python_y, python_x_scale, python_y_scale, python_conn_type);
			create_icon(trove_name, trove_x, trove_y, trove_x_scale, trove_y_scale, trove_conn_type);
			create_icon(java_name, java_x, java_y, java_x_scale, java_y_scale, java_conn_type);
			create_icon(ruby_name, ruby_x, ruby_y, ruby_x_scale, ruby_y_scale, ruby_conn_type);
			create_icon(lb_name, lb_x, lb_y, lb_x_scale, lb_y_scale, lb_conn_type);


			// Create the main stage ticker to keep everything updated
			createjs.Ticker.setFPS(fps);
			createjs.Ticker.addEventListener("tick", tick);
			stage.update();
		}


		function create_icon(icon_name, x_pos, y_pos, x_scale, y_scale, conn_type) {
			var bmp = new createjs.Bitmap(queue.getResult(icon_name));
			bmp.scaleX = x_scale;
			bmp.scaleY = y_scale;
			bmp.regX = bmp.image.width * 0.5;
			bmp.regY = bmp.image.height * 0.5;

            var dragger = new createjs.Container();
			container_list.push([dragger.id, icon_name, x_pos, y_pos, x_scale, y_scale, conn_type]);
            dragger.x = x_pos;
            dragger.y = y_pos;
            dragger.addChild(bmp);

            dragger.on("pressmove", function(evt) {
				if (evt.nativeEvent.button == 2) { // Disable right click drag/drop
					return;
				}
            	mouse_status = 3;
               	evt.currentTarget.x = evt.stageX;
               	evt.currentTarget.y = evt.stageY;
               	stage.update();
            });
			dragger.addEventListener("mousedown", function(evnt) {
				if (evnt.nativeEvent.button == 2) {
					if (mouse_status == 4) { // last click
						if (last_mouse_obj == null) {
							mouse_status = 0;
							return;
						}
						if (last_mouse_obj == evnt.currentTarget) {
							mouse_status = 0;
							return;
						}

						create_line(last_mouse_obj, evnt.currentTarget, true);

						mouse_status = 0;
						last_mouse_obj = null;
						return;
					} else {
						last_mouse_obj = evnt.currentTarget;
					}
					mouse_status = 4;
					return;
				}
				
				mouse_status = 1;
				evnt.addEventListener("mouseup", function(evt) {
// TODO - make the line follow the drag operation
					// Add a new draggable icon to replace the one moved
					if (mouse_status == 3) { // pressmove - this should be the end
						for (var i=0; i<container_list.length; i++) {
							if (container_list[i][0] == evnt.currentTarget.id) {
								create_icon(container_list[i][1], 
									container_list[i][2], container_list[i][3],
									container_list[i][4], container_list[i][5]);
							}
						}

						// Remove old lines and draw new ones if needed
						for (var i=conn_list.length - 1; i >= 0; i--) {
							if (conn_list[i][0] == evnt.currentTarget ||
								conn_list[i][1] == evnt.currentTarget) {
								create_line(conn_list[i][0], conn_list[i][1], false);
								remove_line(conn_list[i][2]);
								conn_list.splice(i, 1);
							}
						}
					}

					mouse_status = 2;
				});
			});

			stage.addChild(dragger);
		}


		function create_line(src_obj, dest_obj, validate) {
			if (validate == true) {
				var src_conn_type, dest_conn_type, num_src_conn, num_dest_conn;
				src_conn_type = null;
				dest_conn_type = null;

				for (var i = 0; i < container_list.length; i++) {
					if (container_list[i][0] == src_obj.id) {
						src_conn_type = container_list[i][6];
					}
					if (container_list[i][0] == dest_obj.id) {
						dest_conn_type = container_list[i][6];
					}
				}
// TODO - add non-alert visible notification that the connection was not allowed
//				if (src_conn_type == null || dest_conn_type == null) {
//					alert("These two components may not be directly connected.");
//					return;
//				}
//				if (Math.abs(src_conn_type - dest_conn_type) != 1) {
//					alert("These two components may not be directly connected.");
//					return;
//				}

				// Check if the objects are already connected, if so, delete the connection
				for (var i = conn_list.length - 1; i >= 0; i--) {
					if (conn_list[i][0] == src_obj || conn_list[i][0] == dest_obj) {
						if (conn_list[i][1] == src_obj || conn_list[i][1] == dest_obj) {
							remove_line(conn_list[i][2]);
							conn_list.splice(i, 1);

							// If no connections, remove glow
							if (num_connections(src_obj) <= 0) {
								remove_glow(src_obj);
							}
							if (num_connections(dest_obj) <= 0) {
								remove_glow(dest_obj);							
							}

							return;
						}
					}
				}
			}

			var line = new createjs.Shape();
			line.graphics.setStrokeStyle(line_width);
			line.graphics.beginLinearGradientStroke(["#000", "#F00"], [0, 1], 0, 0, 0, 300);
			line.graphics.moveTo(src_obj.x, src_obj.y);
			line.graphics.lineTo(dest_obj.x, dest_obj.y);
			line.graphics.endStroke();
			stage.addChild(line);
			stage.setChildIndex(line, 0);
			conn_list.push([src_obj, dest_obj, line]);
			add_glow(src_obj);
			add_glow(dest_obj);
		}


		function num_connections(obj) {
			var num_conn = 0;
			for (var i = 0; i < conn_list.length; i++) {
				if (conn_list[i][0] == obj || conn_list[i][1] == obj) {
					num_conn = num_conn + 1;
				}
			}
			return num_conn;
		}
		

		function remove_line(line_obj) {
			stage.removeChild(line_obj);
		}
		

		function tick() {
			stage.update();
		}


		function calc_distance(x1, y1, x2, y2) {
			x_delta = Math.pow((x2 - x1), 2);
			y_delta = Math.pow((y2 - y1), 2);
			retval = Math.sqrt((x_delta + y_delta));
			return retval;
		}


		function add_glow(cont) {
			if (cont.getNumChildren() > 1) {
				//console.log("Trying to add more than 2 children to a dragger.");
				return;
			}
			var graphics = new createjs.Graphics();
			graphics.beginRadialGradientFill([glow_start_color, glow_end_color], [0, 1],
				0, 0, target_width / 8, 0, 0, target_width / 2);
			graphics.drawCircle(0, 0, target_width / 2);
			target = new createjs.Shape(graphics);
			cont.addChild(target);
			cont.setChildIndex(target, 0);

			createjs.Tween.get(target, {loop:true})
				.to({alpha:0}, 2000)
				.to({alpha:1}, 2000);
		}


		function remove_glow(cont) {
			if (cont.getNumChildren() < 2) {
				console.log("Attempt to remove a non-existant glow shape.");
				return;
			}
			cont.removeChildAt(0); // glow shape is always 0
		}

        </script>
    </head>

    <body onload="preinit();">
        <div id="main">
            <H1>Solum M2 Demo</H1>
            <canvas id="canvas" width="800" height="600" style="background-color:#FCFCFF">
                <p>Your browser does not support HTML5 Canvas which is required to see this content.</p>
            </canvas>
        </div>
    </body>
</html>
